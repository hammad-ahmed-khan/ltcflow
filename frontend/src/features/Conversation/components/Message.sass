// Enhanced Message.sass with NO FLICKER - Fixed Context Menu and Dropdown styles

.messages-wrapper
  .message.attach-previous
    padding-top: 0
  .message.attach-next
    padding-bottom: 3px
  .spacer
    width: 60px
    height: 60px
  .message
    > .picture
      margin-bottom: -20px
    > .spacer
      margin-bottom: -20px
  .message.left
    a
      color: #666 !important
  .chat .message .content .bubble.attach-previous.left
    border-top-left-radius: 0
  .chat .message .content .bubble.attach-previous.right
    border-top-right-radius: 0
  .chat .message .content .bubble.attach-next.left
    border-bottom-left-radius: 0
  .chat .message .content .bubble.attach-next.right
    border-bottom-right-radius: 0
  .bubble.right a
    color: white
  .bubble.left a
    color: #fff

  .content-download
    display: flex
    align-items: center
  .content-name
    font-weight: bold
  .content-size
    font-size: 12px
  .content-icon
    min-width: 27px
    width: 27px
    font-size: 18px
    margin-left: 10px

// Deleted Message Styles
.deleted-message
  opacity: 0.7
  font-style: italic
  
  .deleted-message-content
    display: flex
    align-items: center
    gap: 8px
    color: #999 !important
    font-size: 14px
    padding: 2px 0
    
    .deleted-message-icon
      font-size: 12px
      opacity: 0.6
      
    .deleted-message-text
      font-style: italic

.deleted-message.bubble
  background: #f5f5f5 !important
  color: #999 !important
  border: 1px solid #e0e0e0

.deleted-message.bubble.right
  background: #f0f0f0 !important
  color: #999 !important

.deleted-message.bubble.left
  background: #f8f8f8 !important
  color: #999 !important

// ðŸ”¥ CRITICAL FIX: Absolute positioning prevents layout shift
.message-with-menu
  position: relative
  
  .message-content-wrapper
    position: relative
    // NO flex/gap here - keeps bubble size constant

  // Desktop Dropdown Button - ABSOLUTELY POSITIONED (no layout shift!)
  .message-dropdown-container
    position: absolute
    top: 50%
    transform: translateY(-50%)
    opacity: 0
    visibility: hidden
    transition: opacity 0.2s ease, visibility 0.2s ease
    pointer-events: none
    z-index: 10
    
    .message-dropdown-trigger
      background: rgba(0, 0, 0, 0.05)
      border: none
      border-radius: 50%
      width: 32px
      height: 32px
      min-width: 32px
      min-height: 32px
      display: flex
      align-items: center
      justify-content: center
      cursor: pointer
      color: #666
      font-size: 16px
      padding: 0
      transition: all 0.15s ease
      
      &:hover
        background: rgba(0, 0, 0, 0.1)
        color: #333
        transform: scale(1.05)
        
      &:active
        transform: scale(0.95)

    .message-dropdown-menu
      position: absolute
      top: calc(100% + 4px)
      background: white
      border: 1px solid #e1e1e1
      border-radius: 8px
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15)
      min-width: 165px
      z-index: 100
      animation: dropdownFadeIn 0.15s ease-out
      overflow: hidden
      
      .dropdown-item
        display: flex
        align-items: center
        gap: 10px
        padding: 12px 16px
        cursor: pointer
        font-size: 14px
        color: #333
        transition: background-color 0.15s ease
        white-space: nowrap
        
        &:hover
          background-color: #f5f5f5
          
        &.delete-item
          color: #e53e3e
          
          &:hover
            background-color: #fed7d7
            
        svg
          font-size: 16px
          min-width: 16px

  // Show dropdown button on hover
  &:hover .message-dropdown-container
    opacity: 1
    visibility: visible
    pointer-events: auto

// Positioning for left-aligned messages (received)
.message-with-menu.left
  .message-dropdown-container
    right: -40px
    
    .message-dropdown-menu
      right: 0

// Positioning for right-aligned messages (sent)
.message-with-menu.right
  .message-dropdown-container
    left: -40px
    
    .message-dropdown-menu
      left: 0

// Context Menu (for right-click and mobile long-press)
.message-context-menu
  background: white
  border: 1px solid #e1e1e1
  border-radius: 8px
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15)
  min-width: 180px
  z-index: 1000
  animation: contextMenuFadeIn 0.2s ease-out
  overflow: hidden
  
  .context-menu-item
    display: flex
    align-items: center
    gap: 12px
    padding: 14px 18px
    cursor: pointer
    font-size: 14px
    color: #333
    transition: background-color 0.15s ease
    border: none
    width: 100%
    text-align: left
    background: none
    white-space: nowrap
    
    &:hover
      background-color: #f5f5f5
      
    &.delete-item
      color: #e53e3e
      
      &:hover
        background-color: #fed7d7
        
    svg
      font-size: 16px
      min-width: 16px

// Animations
@keyframes dropdownFadeIn
  from
    opacity: 0
    transform: translateY(-4px)
  to
    opacity: 1
    transform: translateY(0)

@keyframes contextMenuFadeIn
  from
    opacity: 0
    transform: scale(0.95)
  to
    opacity: 1
    transform: scale(1)

// Mobile-specific styles
@media (max-width: 767px)
  .message-with-menu
    // Hide dropdown button on mobile (use long-press instead)
    .message-dropdown-container
      display: none !important
      
    // Enhance touch target for long-press
    .message-content-wrapper
      .bubble, .bubble-image, .emoji-bubble
        position: relative
        user-select: none
        -webkit-user-select: none
        -webkit-touch-callout: none
        
  .message-context-menu
    min-width: 200px
    
    .context-menu-item
      padding: 16px 20px
      font-size: 16px
      
      svg
        font-size: 18px

// Tablet adjustments
@media (min-width: 768px) and (max-width: 1024px)
  .message-with-menu
    .message-dropdown-container
      .message-dropdown-trigger
        width: 28px
        height: 28px
        min-width: 28px
        min-height: 28px
        font-size: 14px

// Smooth hover transition for message bubbles
.message-with-menu
  .bubble, .bubble-image, .emoji-bubble
    transition: box-shadow 0.2s ease, transform 0.1s ease
    
  &:hover
    .bubble, .bubble-image, .emoji-bubble
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08)

// Prevent text selection issues on mobile
.message-content-wrapper
  -webkit-tap-highlight-color: transparent
  
  .bubble, .emoji-bubble
    -webkit-user-select: text
    -moz-user-select: text
    -ms-user-select: text
    user-select: text

// Better focus states for accessibility
.message-dropdown-trigger:focus,
.context-menu-item:focus,
.dropdown-item:focus
  outline: 2px solid #007bff
  outline-offset: 2px

// Dark mode support
@media (prefers-color-scheme: dark)
  .message-dropdown-container
    .message-dropdown-trigger
      background: rgba(255, 255, 255, 0.1)
      color: #ddd
      
      &:hover
        background: rgba(255, 255, 255, 0.15)
        color: #fff
        
    .message-dropdown-menu
      background: #2a2a2a
      border-color: #444
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4)
      
      .dropdown-item
        color: #ddd
        
        &:hover
          background-color: #3a3a3a
          
        &.delete-item
          color: #ff6b6b
          
          &:hover
            background-color: #4a2020
            
  .message-context-menu
    background: #2a2a2a
    border-color: #444
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4)
    
    .context-menu-item
      color: #ddd
      
      &:hover
        background-color: #3a3a3a
        
      &.delete-item
        color: #ff6b6b
        
        &:hover
          background-color: #4a2020

  .deleted-message
    background-color: #2a2a2a
    color: #666

    .deleted-icon
      color: #666

// Loading/skeleton state for smoother UX
.message-loading
  .bubble
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)
    background-size: 200% 100%
    animation: loading 1.5s ease-in-out infinite

@keyframes loading
  0%
    background-position: 200% 0
  100%
    background-position: -200% 0

// Ensure proper z-index stacking
.message-with-menu
  z-index: 1
  
  &:hover
    z-index: 2
    
  .message-dropdown-container
    z-index: 10
    
  .message-context-menu
    z-index: 1000
    
  .message-dropdown-menu
    z-index: 100

// Improve click/touch area for better UX
.message-dropdown-trigger,
.context-menu-item,
.dropdown-item
  position: relative
  
  &::before
    content: ''
    position: absolute
    top: -4px
    right: -4px
    bottom: -4px
    left: -4px
    
// RTL support
[dir="rtl"]
  .message-with-menu.left
    .message-dropdown-container
      right: auto
      left: -40px
      
  .message-with-menu.right
    .message-dropdown-container
      left: auto
      right: -40px

// Scroll to Bottom Button - WhatsApp Style
.messages-wrapper
  position: relative

.scroll-to-bottom
  position: absolute
  bottom: 80px
  right: 20px
  width: 42px
  height: 42px
  border-radius: 50%
  background-color: #ffffff
  box-shadow: 0 1px 3px rgba(11, 20, 26, 0.16), 0 1px 2px rgba(11, 20, 26, 0.12)
  border: none
  cursor: pointer
  display: flex
  align-items: center
  justify-content: center
  transition: all 0.2s ease
  z-index: 100
  color: #54656f
  animation: buttonFadeIn 0.2s ease-out

  &:hover
    background-color: #f5f6f6
    box-shadow: 0 2px 6px rgba(11, 20, 26, 0.2), 0 2px 4px rgba(11, 20, 26, 0.16)
    transform: scale(1.05)

  &:active
    transform: scale(0.95)

  svg
    width: 20px
    height: 20px
    transition: transform 0.2s ease

  &:hover svg
    transform: translateY(2px)

// Unread count badge
.unread-badge
  position: absolute
  top: -6px
  right: -6px
  background-color: #25d366
  color: white
  border-radius: 10px
  padding: 0px 5px
  font-size: 12px
  font-weight: 700
  min-width: 18px
  height: 18px
  display: flex
  align-items: center
  justify-content: center
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3)
  animation: badge-pop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)
  line-height: 1

@keyframes badge-pop
  0%
    transform: scale(0)
  50%
    transform: scale(1.2)
  100%
    transform: scale(1)

@keyframes buttonFadeIn
  0%
    opacity: 0
    transform: scale(0.8)
  100%
    opacity: 1
    transform: scale(1)

// Dark mode support
@media (prefers-color-scheme: dark)
  .scroll-to-bottom
    background-color: #2a2f32
    color: #d1d7db
    
    &:hover
      background-color: #374045

// Mobile responsiveness
@media (max-width: 768px)
  .scroll-to-bottom
    width: 40px
    height: 40px
    bottom: 70px
    right: 12px
    
    svg
      width: 18px
      height: 18px
      
  .unread-badge
    font-size: 11px
    min-width: 16px
    height: 16px
    top: -5px
    right: -5px